북마크
================

Contents
--------------

1. 시작하며..
2. 프로젝트 셋업
3. 모델 만들기
4. 북마크 목록 보기 기능 만들기
5. 북마크 추가 기능 만들기
6. 북마크 상세 보기 기능 만들기
7. 북마크 수정 기능 만들기
8. 북마크 삭제 기능 만들기
9. 북마크 UI 개선하기
10. 배포하기
11. 마치며..

## 시작하며..

이번 장에서는 "북마크" 그러니까 사이트 이름과 URL 을 저장하고, 그것들의 목록을 보여주고 추가/수정/삭제할 수 있는 간단한 앱을 만들어볼 것입니다.


## 프로젝트 셋업

프로젝트 셋업을 합시다. 먼저 적당한 위치에서 프로젝트 디렉토리를 생성해주세요.

```bash
# bookmark 디렉토리 생성
$ mkdir bookmark

# bookmark 위치로 이동
$ cd bookmark
```

이제 파이썬 가상 환경을 만들어줍니다.

```bash
# 가상 환경 설정
$ python3 -m virtualenv venv

# 가상 환경 활성화
$ source venv/bin/activate

# 제대로 설정이 됬다면 (venv)가 떠야 합니다!
$ (venv) _
```

이제 장고를 설치합니다.

```bash
# 장고 설치
$ (venv) pip install django
```

그 후 장고 프로젝트를 설정합니다.

```bash
# 장고 프로젝트 설정
$ (venv) django-admin startproject config .
```

그리고 프로젝트에서 쓸 관리자 계정을 생성하도록 하겠습니다.

```bash
$ (venv) python manage.py createsuperuser 
```

이제 `bookmark` 앱을 만들어보겠습니다.

```bash
# bookmark 앱 생성
$ (venv) python manage.py startapp bookmark
```

그 후 `config/settings.py`에서 북마크 앱을 연결해줍니다.

bookmark/config/settings.py
```python
# ...

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'bookmark', # 추가 코드
]

# ...
```

자 이렇게 해서 프로젝트 셋업이 끝났습니다.

## 모델 만들기

이제 모델을 만들겠습니다. `bookmark/models.py`에 다음 코드를 입력하세요.

bookmark/bookmark/models.py
```python
from django.db import models

# Create your models here.
class Bookmark(models.Model):

    site_name = models.CharField(max_length=100)
    url = models.URLField('Site URL')

    def __str__(self):
        return "name: {}, address: {}".format(self.site_name, self.url)
```

우리가 앱에서 사이트 이름과 url을 저장할 수 있도록 site_name, url 필드를 지정하였습니다. 이제 모델을 만들었으니 마이그레이션을 합시다.

```bash
# 북마크 앱 마이그레이션 생성
$ (venv) python manage.py makemigrations bookmark

# 전체 프로젝트 마이그레이션
$ (venv) python manage.py migrate
```

자, 이제 관리자 페이지와 모델을 연결해보겠습니다. `bookmark/admin.py`에 다음 코드를 입력하세요.

bookmark/bookmark/admin.py
```python
from django.contrib import admin

# Register your models here.
from .models import Bookmark

admin.site.register(Bookmark)
```

이제 개발 서버를 실행한 후 관리자 페이지에 들어가서, 원활한 실습을 위해 몇 개의 북마크를 추가해 주세요.

```bash
# 서버 실행
$ (venv) python manage.py runserver
```

    참고! 관리자 페이지 들어가기
    관리자는 http://localhost:8000/admin 으로 들어갈 수 있습니다. 처음 설정한 관리자 계정으로 로그인 해보세요. 만약 잘 설정했다면 북마크를 관리할 수 있는 Bookmarks를 볼 수 있을 것입니다.

    참고! 관리자 페이지와 모델의 __str__ 메소드
    관리자의 등록된 모델에 __str__ 메소드가 없으면, 데이터 목록에서 `Bookmark object(1)` 형식으로 출력이 됩니다. 이러면 관리자 페이지임에도 우리가 볼 수 있는 것이 한정적이죠. 저번 장에서 배운 관리자 커스터마이징도 쓸 수 있지만 필드가 매우 간단하기 때문에, 모델의 __str__ 메소드로 설정한 것입니다.


## 북마크 목록 보기 기능 만들기

이번에는 북마크 목록 보기 기능을 만들어보겠습니다. 우리는 저번 시간에 제네릭 뷰에 대해서 배웠는데, 장고는 목록 보기 뿐 아니라, 상세보기, 추가/수정/삭제 할 수 있는 제네릭 뷰들을 모두 만들어 두었습니다. 우리는 그것을 이용할 것입니다. `bookmark/views.py`에 다음을 입력해주세요.

bookmark/bookmark/views.py
```python
from django.views.generic.list import ListView

from .models import Bookmark
# Create your views here.

class BookmarkListView(ListView):
    model = Bookmark
```

그리고 이 뷰와 url을 연결하겠습니다. 북마크 목록은 `bookmark/` url에 연결하겠습니다. 먼저 `bookmark/urls.py`를 만들고 다음을 입력하세요.

bookmark/bookmark/urls.py
```python
from django.urls import path

from .views import BookmarkListView

urlpatterns = [
    path('/', BookmarkListView.as_view(), name='list'),
]
```

이 url이 bookmark/ 에서 "/"의 역할을 합니다. 이제 `config/urls.py`에서 bookmark 앱의 url들을 연결하겠습니다. 다음을 해당 파일에 입력해주세요.

bookmark/config/urls.py
```python
from django.contrib import admin
# include 메소드를 추가합니다.
from django.urls import path, include 

urlpatterns = [
    path('admin/', admin.site.urls),
    # 아래 코드가 추가 코드입니다.
    path('bookmark/', include('bookmark.urls'))
]
```

이제 뷰와 템플릿을 연결하겠습니다. `bookmark/templates/bookmark/bookmark_list.html` 파일을 만들고 다음을 입력해주세요.

bookmark/bookmark/templates/bookmark/bookmark_list.html
```html
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8"/>
        <title>북마크 리스트 뷰</title>
    </head>
    <body>
        <div class="btn-group">
            <a href="#" class="btn btn-info">Add Bookmark</a>
        </div>
        <p></p>
        <table class="table">
            <thead>
                <th scope="col">#</th>
                <th scope="col">Site</th>
                <th scope="col">URL</th>
                <th scope="col">Modify</th>
                <th scope="col">Delete</th>
            </thead>
            <tbody>
                {% for bookmark in object_list %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <a href="#">{{ bookmark.site_name }}</a>
                        </td>
                        <td>
                            <a href="{{ bookmark.url }}" target="_blank">{{ bookmark.url }}</a>
                        </td>
                        <td>
                            <a href="#" class="btn btn-success btn-sm">Modify</a>
                        </td>
                        <td>
                            <a href="#" class="btn btn-danger btn-sm">Delete</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </body>
</html>
```

여기서 `{% for bookmark in object_list %}`에서 **object_list**는 제네릭 뷰를 상속 받은 **BookmarkListView**가 해당 모델의 리스트를 만들어 넣어주는 값입니다. 이것을 렌더리하는 것이지요. 이제 개발 서버를 구동시키면 테이블 형태로 북마크가 보일 것입니다.


## 북마크 추가 기능 만들기

자, 북마크 추가 기능을 만들어 봅시다. 먼저 `bookmark/views.py`에 제네릭 뷰 중 모델을 생성할 수 있는 `CreateView`를 상속 받아 뷰를 만들어보겠습니다. 다음은 코드입니다.

bookmark/bookmark/views.py
```python
## 동일

from django.views.generic.edit import CreateView
from django.urls import reverse_lazy

# 동일

class BookmarkCreateView(CreateView):
    model = Bookmark
    # 폼으로 입력 받을 필드
    fields = ['site_name', 'url'] 
    # 폼 입력 후 모델이 성공적으로 만들어지면 이동할 페이지 -> / (name=list)
    success_url = reverse_lazy('list')
    # 사용할 템플릿의 접미사를 변경하는 설정 값.
    template_name_suffix = '_create'
```

안에 필드를 자세히 살펴봅시다. `model`은 `BookmarkListView`에서 썼듯이 말 그대로 해당 모델을 의미합니다. `fileds`는 보통 데이터를 생성할 때 form 태그 형식으로 넘어오는데 그 때 쓰일 필드들을 뜻합니다. `success_url`은 데이터 생성이 성공했을 때 리다이렉트할 url을 뜻합니다. 여기서는 **reverse_lazy** 라는 함수로 urls.py 에서 정의한 `list`라는 이름의 url로 연결합니다. 즉 성공한 후에 바로 목록 뷰로 이동합니다. `template_name_suffix`는 템플릿 파일의 접미사를 뜻합니다. 즉 ~_create.html 을 만들면 이 파일을 템플릿으로 씁니다.

이제 이 뷰를 url로 연결하겠습니다. `bookmark/urls.py`에 "add/" url에 우리가 만든 `BookmarkCreateView`를 연결해주세요. 다음은 코드입니다.

bookmark/bookmark/urls.py
```python
from django.urls import path
# BookmarkCreateView 추가
from .views import BookmarkListView, BookmarkCreateView # BookmarkCreateView 추가

urlpatterns = [
    path('', BookmarkListView.as_view(), name='list'),
    # 아래가 추가 코드입니다.
    path('add/', BookmarkCreateView.as_view(), name='add'),
]
```

자 이제, 모델을 생성할 페이지 `bookmark/templates/bookmark/bookmark_create.html`를 만들어 뷰와 연결하겠습니다.

bookmark/bookmark/templates/bookmark/bookmark_create.html
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Bookmark Create View</title>
</head>
<body>
    <form action="" method="post">
        <!-- csrf 토큰 방지 --->
        {% csrf_token %}
        <!-- 클래스 형 뷰의 옵션 값. 설정한 필드 폼 태그 출력 후 p 태크로 감싸줌. -->
        {{ form.as_p }}
        <input type="submit" value="Add" class="btn btn-info btn-sm"/>
    </form>
</body>
</html>
```

여기서 템플릿 엔진 코드를 살펴봅시다. `{% csrf_token %}`은 CSRF(Cross Site Request Forgrey) 공격을 막기 위한 코드입니다. 외부 사이트에서 우리가 만든 사이트에 로그인 유저 권한으로 공격하는 것을 막습니다. `{{ form.as_p }}`에서 `form`은 `BookmarkCreateView`가 넣어준 값인데 우리가 설정한 "fields"에 따라 input 필드 태그를 만들어줍니다. `as_p`는 이 태그들을 p 태그로 감싸줍니다. 

자, 마지막으로 목록 페이지에서 Add Bookmark 링크에 우리 "bookmark/add" url을 달아보겠습니다. `bookmark/templates/bookmark/bookmark_list.html`을 다음처럼 수정해주세요.

bookmark/bookmark/templates/bookmark/bookmark_create.html
```html
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8"/>
        <title>북마크 리스트 뷰</title>
    </head>
    <body>
        <div class="btn-group">
            <a href="{% url 'add' %}" class="btn btn-info">Add Bookmark</a>
        </div>
        <!-- 이전 코드와 동일 -->
    </body>
</html>
```

템플릿 엔진의 도움으로 이렇게 하면 해당 앱의 설정한 url 이름으로 url을 동적으로 매핑시켜줍니다. 이제 개발 서버를 키고 잘 동작하나 확인해보세요.


## 북마크 상세 보기 기능 만들기

이제 상세보기 기능을 구현할 것입니다. 역시 제네릭 뷰인 DetailView를 상속받아 만들겁니다. `bookmark/views.py`를 다음처럼 수정해주세요.

bookmark/bookmark/views.py
```python
# 이전과 동일

from django.views.generic.detail import DetailView

# 이전과 동일

class BookmarkDetailView(DetailView):
    model = Bookmark
```

이제 url에 매핑합시다. 우리는 details/<int:pk> 형식에 매핑하겠습니다. 무슨 말이냐면 details/1 로 접속했을 때 id=1인 북마크의 상세 보기 페이지로 이동하게 만들겠다라는 뜻입니다. 자 `bookmark/urls.py `를  다음처럼 고쳐주세요.

bookmark/bookmark/urls.py
```python
from django.urls import path

# BookmarkDetailView 추가
from .views import BookmarkListView, BookmarkCreateView, BookmarkDetailView

urlpatterns = [
    path('', BookmarkListView.as_view(), name='list'),
    path('add/', BookmarkCreateView.as_view(), name='add'),
    # 아래 코드가 추가 코드입니다.
    path('detail/<int:pk>/', BookmarkDetailView.as_view(), name='detail'),
]
```

이제 뷰에 연결될 템플릿 파일을 작성하겠습니다.

bookmark/bookmark/templates/bookmark/bookmark_detail.html
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>북마크 상세보기 뷰</title>
</head>
<body>
    {{ object.site_name }} <br/>
    {{ object.url }}
</body>
</html>
```

간단하죠? 추가하기 페이지를 추가했을 때와 마찬가지로 목록 페이지에서 상세 보기 페이지로 이동할 수 있도록 url을 매핑하도록 하겠습니다. `bookmark_list.html`을 다음 부분을 수정해주세요.

bookmark/bookmark/templates/bookmark/bookmark_list.html
```html
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8"/>
        <title>북마크 리스트 뷰</title>
    </head>
    <body>
        <!-- 이전과 동일 -->
            <tbody>
                {% for bookmark in object_list %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <!-- 여기가 수정된 코드입니다. -->
                            <a href="{% url 'detail' pk=bookmark.id %}">{{ bookmark.site_name }}</a>
                        </td>
                        <td>
                            <a href="{{ bookmark.url }}" target="_blank">{{ bookmark.url }}</a>
                        </td>
        <!-- 이전과 동일 -->
    </body>
</html>
```

역시 템플릿 엔진의 도움을 받아 url을 매핑해줍니다. 이때 bookmark 객체의 id로 pk를 넣어주는데를 유심히 살펴봐주세요.


## 북마크 수정 기능 만들기

이번에는 수정 기능을 만들어보도록 하겠습니다. 역시 제네릭 뷰의 **UpdateView**를 상속받아 만들도록 하겠습니다.

bookmark/bookmark/views.py
```python
# 이전과 동일
# UpdateView 코드 추가
from django.views.generic.edit import CreateView, UpdateView

# 이전과 동일

class BookmarkUpdateView(UpdateView):
    model = Bookmark
    fields = ['site_name', 'url'] 
    template_name_suffix = '_update'

```

이제 우리가 만든 뷰와 url과 매핑시키겠습니다. 이번에 매핑할 url은 `update/<int:pk>`입니다.

bookmark/bookmark/urls.py
```python
from django.urls import path

# 추가 코드 BookmarkUpdateView
from .views import BookmarkListView, BookmarkCreateView, BookmarkDetailView, BookmarkUpdateView

urlpatterns = [
    path('', BookmarkListView.as_view(), name='list'),
    path('add/', BookmarkCreateView.as_view(), name='add'),
    path('detail/<int:pk>/', BookmarkDetailView.as_view(), name='detail'),

    # 추가 코드
    path('update/<int:pk>/', BookmarkUpdateView.as_view(), name='update'),
]
```

그 다음 뷰와 템플릿을 연결하겠습니다. 이번에 template_name_suffix가 **_update**니까 `bookmark_update.html`로 만들어주세요.

bookmark/bookmark/templates/bookmark/bookmark_update.html
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Bookmark Update View</title>
</head>
<body>
    <form action="" method="post">
        <!-- csrf 토큰 방지 --->
        {% csrf_token %}
        <!-- 클래스 형 뷰의 옵션 값. 설정한 필드 폼 태그 출력 후 p 태크로 감싸줌. -->
        {{ form.as_p }}
        <input type="submit" value="Update" class="btn btn-info btn-sm"/>
    </form>
</body>
</html>
```

인풋 태그의 value 값을 제외하고는 북마크 추가 페이지와 동일합니다. 이제 목록 페이지에서 Update 버튼에 url을 매핑시켜 수정 페이지로 이동하게 만들도록 하겠습니다.

bookmark/bookmark/templates/bookmark/bookmark_list.html
```html
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8"/>
        <title>북마크 리스트 뷰</title>
    </head>
    <body>
        <!-- 이전과 동일 -->
                {% for bookmark in object_list %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <a href="{% url 'detail' pk=bookmark.id %}">{{ bookmark.site_name }}</a>
                        </td>
                        <td>
                            <a href="{{ bookmark.url }}" target="_blank">{{ bookmark.url }}</a>
                        </td>
                        <td>
                            <a href="{% url 'update' pk=bookmark.id %}" class="btn btn-success btn-sm">Modify</a>
                        </td>
                        <td>
                            <a href="#" class="btn btn-danger btn-sm">Delete</a>
                        </td>
        <!-- 이전과 동일 -->
    </body>
</html>
```

이전 절과 똑같은 내용이므로 설명은 생략합니다. 근데 서버를 켜보면 잘 동작하지 않습니다. 왜 그럴까요? UpdateView에서도 CreateView 작업처럼 성공 시 이동할 리다이렉트 주소가 필요합니다. `BookmarkCreateView`처럼 만들어도 되지만, 다른 방법을 써보도록 하겠습니다. `bookmark/models.py`를 다음처럼 수정해주세요.

bookmark/bookmark/models.py
```python
from django.db import models
# 추가 코드
from django.urls import reverse
# Create your models here.
class Bookmark(models.Model):

    site_name = models.CharField(max_length=100)
    url = models.URLField('Site URL')

    def __str__(self):
        return "name: {}, address: {}".format(self.site_name, self.url)
    # 추가 코드
    def get_absolute_url(self):
        return reverse('detail', kwargs={'pk': self.pk})
```

`reverse`함수의 도움을 받아 모델 내부의 절대 경로를 만들어주었습니다. 만약 우리의 뷰에서 리다이렉트가 일어날 경우, 설정하지 않았을 때 이 값으로 이동시키는 방법입니다.


## 북마크 삭제 기능 만들기

자, 이번에는 삭제 페이지를 만들어보겠습니다. 먼저 `bookmark/views.py`를 다음처럼 수정해주세요.

bookmark/bookmark/views.py
```python
# 이전과 동일
# 코드 추가DeleteView
from django.views.generic.edit import CreateView, UpdateView, DeleteView

# 이전과 동일

class BookmarkDeleteView(DeleteView):
    model = Bookmark
    success_url = reverse_lazy('list')
```

이제 만든 뷰를 url과 매핑하겠습니다. 이번에 매핑시킬 url은 delete/<int:pk> 입니다. `bookmark/urls.py`를 다음처럼 수정해주세요.

bookmark/bookmark/urls.py
```python
from django.urls import path

# 추가 코드 BookmarkDeleteView
from .views import BookmarkListView, BookmarkCreateView, BookmarkDetailView, BookmarkUpdateView, BookmarkDeleteView

urlpatterns = [
    path('', BookmarkListView.as_view(), name='list'),
    path('add/', BookmarkCreateView.as_view(), name='add'),
    path('detail/<int:pk>/', BookmarkDetailView.as_view(), name='detail'),
    path('update/<int:pk>/', BookmarkUpdateView.as_view(), name='update'),

    # 아래가 추가 코드입니다.
    path('delete/<int:pk>/', BookmarkDeleteView.as_view(), name='delete'),
]
```

제네릭 뷰의 `DeleteView`는 좀 특이한데 suffix 이런걸로 연결하는게 아니라 ~_confirm_delete.html 로 연결됩니다. 정말 삭제할 것인가 묻는 페이지로 이동하고 여기서 확인 버튼을 누르면 삭제가 이루어집니다. `bookmark/templates/bookmark/bookmark_confirm_delete.html`을 만들고 다음을 입력하세요.

bookmark/bookmark/templates/bookmark/bookmark_confirm_delete.html
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>북마크 삭제 확인 페이지</title>
</head>
<body>
    <form action="" method="post">
        {% csrf_token %}
        <div class="alert alert-danger">Do you want to delete Bookmark "{{ object }}"</div>
        <input type="submit" value="Delete" class="btn btn-danger"/>
    </form>
</body>
</html>
```

이제 마지막으로 목록 페이지에서 `Delete` 링크를 눌렀을 때, 삭제 확인 페이지로 넘어올 수 있도록 만들겠습니다.

bookmark/bookmark/templates/bookmark/bookmark_list.html
```html
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8"/>
        <title>북마크 리스트 뷰</title>
    </head>
    <body>
        <!-- 이전과 동일 -->
                        <td>
                            <a href="{% url 'update' pk=bookmark.id %}" class="btn btn-success btn-sm">Modify</a>
                        </td>
                        <td>
                            <!-- 수정 코드입니다. -->
                            <a href="{% url 'delete' pk=bookmark.id %}" class="btn btn-danger btn-sm">Delete</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </body>
</html>
```

자, 이제 서버를 켜보면 삭제가 정상적으로 이루어지는 것을 볼 수 있습니다.

## 북마크 UI 개선하기


## 배포하기


## 마치며..

