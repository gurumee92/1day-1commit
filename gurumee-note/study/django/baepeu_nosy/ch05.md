Dstagram
================

Contents
--------------

1. 시작하며..
2. 프로젝트 셋업
3. photo 앱 만들기
4. accounts 앱 만들기
5. 댓글 서비스 Disqus 연동
6. 파일 서비스 S3 연동
7. Heroku 배포
8. 마치며..

## 시작하며..

이번 시간에는 **인스타그램**과 유사한 서비스를 만들어보겠습니다. 그리고 댓글 서비스인 "Disqus"를 서비스에 연동시키고 정적 파일을 "AWS S3"라는 파일 서비스와 연동시켜보도록 하겠습니다. 그리고 마지막으로 "Heroku"에 배포까지 해보도록 하겠습니다. 바로 시작하죠!


## 프로젝트 셋업

먼저 프로젝트를 셋업하겠습니다. 먼저 적당한 프로젝트 디렉토리를 만드세요.

```bash
# 디렉토리 생성
$ mkdir dstagram

# 디렉토리 이동
$ cd dstagram
```

그 후, 파이썬 가상환경을 만들어보도록 하겠습니다.

```bash
# 가상 환경 구성
$ python3 -m virtualenv venv

# virtualenv 활성화
$ source venv/bin/activate
$ (venv)
```

이제 장고를 설치하겠습니다.

```bash
# 장고 설치
$ (venv) pip install django
```

그 후 장고 프로젝트를 설정하겠습니다.

```bash
# 장고 프로젝트 설정
$ (venv) django-amdin stratproject config .
```

그 후 다음 명령어들을 입력해주세요.

```bash
# 관리자 계정 생성
$ (venv) python manage.py createsuperuser

# 디비 마이그레이션
$ (venv) python manage.py migrate
```

## photo 앱 만들기

이제 포스트에 해당하는 사진과, 설명을 쓸 수 있는 앱을 만들도록 하곘습니다.

```bash
$ (venv) python manage.py startapp photo
```

이제 프로젝트와 앱을 연결하겠습니다. `config/settings.py`에서 "INSTALLED_APPS"를 수정해주세요.

dstagram/config/settings.py
```python
# 이전과 동일

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    # 추가한 코드입니다.
    'photo',
]

# 이전과 동일
```

그 다음 모델을 만들도록 하죠.

dstagram/photo/models.py
```python
from django.db import models

# 장고 기본 유저 모델
from django.contrib.auth.models import User
# get_absolute_url을 위한 메소드
from django.urls import reverse
# Create your models here.


class Photo(models.Model):
    """사진 모델입니다."""

    # User와 연결
    author = models.ForeignKey(User, on_delete=models.CASCADE, related_name='user_photos')
    # 포토 이미지가 업로드될 경로입니다.
    photo = models.ImageField(upload_to='photos/%Y/%m/%d', default='photos/no_image.png')
    # 사진에 대한 설명을 저장할 필드
    text = models.TextField()
    # 글 최초 작성일에 대한 필드
    created = models.DateTimeField(auto_now_add=True)
    # 글이 수정된 시간에 대한 필드
    updated = models.DateTimeField(auto_now=True)

    def __str__(self):
        return "{} {}".format(self.author.username, self.created.strftime("%Y-%m-%d %H:%M:%S"))
    
    def get_absolute_url(self):
        """포토의 상세 페이지의 주소를 반환하는 메소드, 추가/수정할 때 리다이렉트를 위한 메소드"""
        return reverse('photo:photo_detail', args=[str(self.id)])


    # updated 기준으로 내림차순 정렬할 메타 정보
    class Meta:
        """사진 모델의 메타 정보입니다."""
        ordering = ['-updated']
```

이제 모델을 만들었으니 마이그레이션을 하겠습니다. 그 전에 원활한 이미지 업로드를 위해서 `pillow`란 모듈을 설치하겠습니다.

```bash
# pillow 모듈 설치
$ (venv) pip install pillow
```

이제 마이그레이션 명령을 진행해주세요.


```bash
# 앱 마이그레이션 명령
$ (venv) python manage.py makemigrations photo

# 실제 DB 마이그레이션
$ (venv) python manage.py migrate photo 0001
```

이제 관리자 페이지에 모델을 연결하겠습니다.

dstagram/photo/admin.py
```python
from django.contrib import admin

from .models import Photo
# Register your models here.

class PhotoAdmin(admin.ModelAdmin):

    # 관리자 펭이지에서 보일  필드 목록
    list_display = ['id', 'author', 'created', 'updated']
    # ForeignKey와 연결된 객체를 보다 알기 쉽게 출력하게끔 설정 models.User의 경우 username 이 보인다.
    raw_id_fields = [ 'author' ]
    # 필터를 적용할 필드
    list_filter = ['created', 'updated', 'author']
    # 검색을 적용할 필드 ForeignKey 는 설정 불가
    search_fields = ['text', 'created']
    # 관리자 페이지에서 적용할 정렬 값
    ordering = ['-updated', '-created']


admin.site.register(Photo, PhotoAdmin)
```

이제 서버를 키고 관리자 페이지에서 모델을 CRUD 할 수 있습니다. 근데 문제가 하나 있습니다. 지금은 photo 앱 하나에서만 사진이 업로드되는데 이때 photos/ 라는 디렉토리가 만들어지면서 여기서 관리합니다. 만약, photo 앱 뿐 아니라 여러 앱이 사진을 업로드하게 된다면 디렉토리 구조가 많이 더러워지겠죠? 

이제 업로드용 폴더 "media"를 만들고 여기서 관리하도록 하겠습니다. 먼저 프로젝트 루트에서 "media" 디렉토리로 만들어주세요. 그 후 `config/settings.py` 가장 끝에 다음 코드를 추가해주세요.

dstagram/config/settings.py
```python
# 이전 코드와 동일

MEDIA_URL = '/media/'

MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
```

이제 관리자 페이지에서 사진을 업로드하면, media/photos 디렉토리에서 사진이 업로드 됩니다. 이제 뷰 작업을 진행하겠습니다. `photo/views.py`에 다음 코드를 작성해주세요.

```python
from django.shortcuts import render, redirect
from django.views.generic.edit import CreateView, DeleteView, UpdateView

from .models import Photo
# Create your views here.

def photo_list(request):
    """ 포토 목록 뷰
    포토의 리스트를 보여주는 뷰, 함수형 뷰로 만들어져서 template list.html과 연결
    url : '/'
    """

    # 포토 목록을 불러옴
    photos = Photo.objects.all()
    # 렌더링 코드 
    return render(request, 'photo/list.html', { 'photos': photos })


class PhotoUploadView(CreateView):
    """ 포토 업로드 뷰
    포토 업로드 뷰, 클래스형 뷰, 아래 입력될 필드를 폼으로 갖고  upload.html 과 연결
    url : '/upload/'
    """
    # 연결될 모델
    model = Photo
    # 폼 입력 필드
    fields = ['photo', 'text']
    # 연결될 템플릿
    template_name = 'photo/upload.html'

    def form_valid(self, form):
        """
        form validation 메소드, 입력이 유효하면 저장 없으면, form 정보를 주어 페이지를 보여준다.
        url : /upload/
        """
        form.instance.author_id = self.request.user.id

        if form.is_valid():
            form.instance.save()
            return redirect('/')

        return self.render_to_response({ 'form': form })


class PhotoDeleteView(DeleteView):
    """ 포토 삭제 뷰
    해당 포토를 삭제, 성공하면 / 로 리다이렉트 한다.
    url : /delete/<int:pk>
    """
    model = Photo
    success_url = "/"
    template_name = "photo/delete.html"



class PhotoUpdateView(UpdateView):
    """ 포토 업데이트 뷰
    해당 포토를 업데이트, 성공하면 /details/<int:pk> 로 리다이렉트 한다.
    url : /update/<int:pk>
    """
    model = Photo
    fields = ['photo', 'text']
    template_name = "photo/update.html"
```

그 후 뷰를 연결할 url 작업을 진행하겠습니다. 먼저 `photo/urls.py`를 만들고 다음 코드를 입력해 주세요.

dstagram/photo/urls.py
```python
from django.urls import path
from django.views.generic.detail import DetailView

from .views import *
from .models import Photo

app_name = 'photo'

urlpatterns = [
    path('', photo_list, name='photo_list'),
    # 인라인 뷰 정의
    path('detail/<int:pk>', DetailView.as_view(model=Photo, template_name='photo/detail.html'), name='photo_detail'),
    path('upload/', PhotoUploadView.as_view(), name='photo_upload'),
    path('delete/<int:pk>', PhotoDeleteView.as_view(), name='photo_delete'),
    path('update/<int:pk>', PhotoUpdateView.as_view(), name='photo_update'),
]
```

그리고 프로젝트에서 앱의 url을 연결하겠습니다. `config/urls.py`에서 코드를 다음처럼 수정해주세요.

```python
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    # 추가된 코드입니다.
    path('', include('photo.urls')),
]
```

이제 뷰와 연결할 템플릿 작업을 하겠습니다. 먼저 `config/settings.py`에서  "TEMPLATES"를 다음처럼 수정해주세요.

dstagram/config/settings.py
```python
# 이전 코드와 동일

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        # 아래가 수정된 코드입니다.
        'DIRS': [os.path.join(BASE_DIR, 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

# 이전 코드와 동일
```

이제 프로젝트 루트에서 `templates` 디렉토리를 만들어 주세요. 그 후 `base.html`을 만들고 다음을 입력해주세요.

dstagram/templates/base.html
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>Dstagram {% block title %} {% endblock title %}</title>
</head>
<body>
    <div class="container">
        <header class="header clearfix">
            <nav class="navbar navbar-expand-lg navbar-light-bg-light">
                <a class="navbar-brand" href="/">Dstagram</a>
                <ul class="nav">
                    <li class="nav-item"><a href="/" class="active nav-link">Home</a></li>
                    
                    {% if user.is_authenticated %}
                    <li class="nav-item"><a href="#" class="active nav-link">Welcome, {{ user.get_username }}</a></li>
                    <li class="nav-item"><a href="{% url 'photo:photo_upload' %}" class="active nav-link">Upload</a></li>
                    <li class="nav-item"><a href="#" class="nav-link">Logout</a></li>
                    {% else %}
                    <li class="nav-item"><a href="#" class="nav-link">Login</a></li>
                    <li class="nav-item"><a href="#" class="nav-link">Signup</a></li>
                    {% endif %}
                </ul>
            </nav>
        </header>
        {% block content %}
          
        {% endblock content %}

        <footer class="footer">
            <p>&copy; 2019 Gurumee. Powerd By Djanog 2</p>
        </footer>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>
```

저번 시간에 작업했던 부트스트랩 적용까지 마쳤습니다. 이제 앱의 템플릿들을 작성하겠습니다. 처음부터 차례대로 delete.html, detail.html, list.html, update.html, upload.html 을 만들고 다음 코드를 입력해주세요.

dstagram/photo/templates/photo/delete.html
```html
{% extends 'base.html' %}

{% block title %}
  - Delete
{% endblock title %}

{% block content %}
<div class="row">
    <div class="col-md-2"></div>
    <div class="col-md-8 pannel pannel-default">
        <div class="alert alert-info">
            Do you want to delete {{ object }}?
        </div>
        <form action="" method="post">
            {{ form.as_p }}
            {% csrf_token %}
            <input type="submit" class="btn btn-danger" value="Confirm" />
        </form>
    </div>
    <div class="col-md-2"></div>
</div>
{% endblock content %}
```

dstagram/photo/templates/photo/detail.html
```html
{% extends 'base.html' %}

{% block title %}
    {{ object.text|truncatechars:10 }}
{% endblock title %}

{% block content %}
<div class="row">
    <div class="col-md-2"></div>
    <div class="col-md-8 pannel pannel-default">
        <p>
            <img src="{{ object.photo.url }}" style="width: 100%;" />
            <button type="button" class="btn btn-outline-primary btn-sm">
                {{ object.author.username }}
            </button>
            <p>
                {{ object.text|linebreaksbr }}
            </p>
            <a href="{% url 'photo:photo_delete' pk=object.id %}" class="btn btn-outline-danger btn-sm float-right">Delete</a>
            <a href="{% url 'photo:photo_update' pk=object.id %}" class="btn btn-outline-success btn-sm float-right">Update</a>
        </p>
    </div>
    <div class="col-md-2"></div>
</div>
{% endblock content %}
```

dstagram/photo/templates/photo/list.html
```html
{% extends "base.html" %}

{% block title %}- List{% endblock title %}

{% block content %}
  {% for post in photos %}
  <div class="row">
    <div class="col-md-2"></div>
    <div class="col-md-8" panel panel-default>
        <p><img src="{{ post.photo.url }}" style="width: 100%;"/></p>
        <button type="button" class="btn btn-xs btn-info">{{ post.author.username }}</button>
        <p>{{ post.text|linebreaksbr }}</p>
        <p class="text-right">
            <a href="{% url 'photo:photo_detail' pk=post.id %}" class="btn btn-xs btn-success">댓글 달기</a>
        </p>
    </div>
    <div class="col-md-2"></div>
  </div>
  {% endfor %}
{% endblock content %}
```

dstagram/photo/templates/photo/update.html
```html
{% extends 'base.html' %}

{% block title %}
  - Update
{% endblock title %}

{% block content %}
<div class="row">
    <div class="col-md-2"></div>
    <div class="col-md-8 pannel pannel-default">
        <form action="" method="post" enctype="multipart/form-data">
            {{ form.as_p }}
            {% csrf_token %}
            <input type="submit" class="btn btn-primary" value="Update" />
        </form>
    </div>
    <div class="col-md-2"></div>
</div>
{% endblock content %}
```

dstagram/photo/templates/photo/upload.html
```html
{% extends 'base.html' %}
{% block title %}- Upload{% endblock title %}

{% block content %}
<div class="row">
    <div class="col-md-2"></div>
    <div class="col-md-8 pannel pannel-default">
        <form action="" method="post" enctype="multipart/form-data">
            {{ form.as_p }}
            {% csrf_token %}
            <input type="submit" class="btn btn-primary" value="Upload" />
        </form>
    </div>
    <div class="col-md-2"></div>
</div>
{% endblock content %}
```

이제 서버를 켜보면 프로젝트가 잘 돌아갈 겁니다.


## accounts 앱 만들기


## 댓글 서비스 Disqus 연동


## 파일 서비스 S3 연동


## Heroku 배포


## 마치며..

